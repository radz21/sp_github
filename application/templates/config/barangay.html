<div class="col-sm-12">
    <div class="card">
        <div class="card-header d-flex justify-content-between">
           <div class="header-title">
                <h4 class="card-title">BARANGAY</h4>
           </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table id="tbl_barangay" class="table table-striped" data-toggle="data-table" width="99.8%">
                    <thead>
                        <th>Id</th>
						<th>Barangay</th>
						<th>Action</th>
                    </thead>
                </table>
            </div>
       </div>
    </div>
</div>

<!-- Modal -->

<div id="modal_brgy" class="modal fade" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content form-control">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle">Barangay Name</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="form_barangay">
            	<div class="modal-body">
	            	<div class="colfull">
						<div class="form-group">
							<input type="text" class="form-control" id="barangay_name">
						</div>
					</div>
	            </div>
	            <div class="modal-footer">
			        <button type="button" class="btn btn-primary" onclick="save_barangay()">Save</button>
			        <button id="rmv_brgy" type="button" class="btn btn-danger" onclick="delete_brgy()">Delete</button>
			    </div>	
           	</form>
        </div>
    </div>
</div>

<!-- End Modal -->


<script type="text/javascript">
	$(document).ready(function(){
		$( "#config-menu" ).addClass("show");
		get_brgy();
	});

	function open_barangary(elem){
		var tr = $(elem).closest('tr')
        var dataArr = $('#tbl_barangay').DataTable().row(tr).data();
        document.getElementById('barangay_name').value = dataArr.barangay;
        barangay_id = dataArr.brgy_id;
        $('#modal_brgy').modal('toggle');
        document.getElementById('rmv_brgy').style.display = 'inline-block';
	}

	function get_brgy(){
		if ($.fn.DataTable.isDataTable("#tbl_barangay")) {
            $("#tbl_barangay").DataTable().destroy();
        }

        var table=$('#tbl_barangay').DataTable({
            responsive: true,
            "ajax": {
                "type": "POST",
                "url": '/get_barangay',
                contentType: 'application/JSON',
                "dataSrc": function(data) {
                    data.forEach(function(item){
                        var open_doc = `<button type='button' class="btn btn-sm btn-icon text-primary flex-end" onclick='open_barangary(this)'>
                        <span class="btn-inner">
                            <svg width="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" >
                                <path d="M11.4925 2.78906H7.75349C4.67849 2.78906 2.75049 4.96606 2.75049 8.04806V16.3621C2.75049 19.4441 4.66949 21.6211 7.75349 21.6211H16.5775C19.6625 21.6211 21.5815 19.4441 21.5815 16.3621V12.3341" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M8.82812 10.921L16.3011 3.44799C17.2321 2.51799 18.7411 2.51799 19.6721 3.44799L20.8891 4.66499C21.8201 5.59599 21.8201 7.10599 20.8891 8.03599L13.3801 15.545C12.9731 15.952 12.4211 16.181 11.8451 16.181H8.09912L8.19312 12.401C8.20712 11.845 8.43412 11.315 8.82812 10.921Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                                <path d="M15.1655 4.60254L19.7315 9.16854" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                            </svg>
                        </span>
                        </button>`

                        item.action =  open_doc;
                    });

                    return data;
                }
            },
            dom: 'Bfrtip',
            columns: [
            	{'data' : 'brgy_id'},
		        {'data' : 'barangay'},
                {'data' : "action" },
            ],
            "columnDefs": [
                {
                    "targets": [0],
                    "visible": false,
                    "searchable": false
                }
            ],
            buttons: [
                {
                	text: "Add",
                    action: function ( e, dt, node, config ) {
                        getbyId('form_barangay').reset();
                        $('#modal_brgy').modal('toggle');
                    },
                    'className': 'btn btn-sm btn-primary'
                }
	        ],

            "pagingType": "full_numbers",
            "pageLength": 7
        });
	}

	function delete_brgy(){
		Swal.fire({
			title: 'Are you sure?',
			text: "You won't be able to revert this!",
			icon: 'warning',
			showCancelButton: true,
			confirmButtonColor: '#d33',
			cancelButtonColor: '#3085d6',
			confirmButtonText: 'Yes, delete it!',
			customClass: 'swal_css',
		}).then((result) => {
			if (result.isConfirmed) {
			  	sendDataWithCallback('/delete_brgy', {brgy_id:barangay_id}, function(res){
					if (res) {
						$('#modal_brgy').modal('hide');
						clear_brgy()
						get_brgy()
						Swal.fire(
						  'Successfully Remove!',
						  'Your file has been deleted.',
						  'success'
						)
					}
				});
				
			}
		})
	}

	var barangay_id = 0; 
	function save_barangay(){
		var brgy = document.getElementById('barangay_name');
		swal.fire({
			title: "Are you sure want to save?",
			text: "Click ok to continue",
			type: "info",
			showCancelButton: true,
			showLoaderOnConfirm: true,
			preConfirm: () => {
				return fetch(console.log("log"))
				.then(
					sendDataWithCallback('/save_barangay', {brgy:brgy.value,brgy_id:barangay_id}, function(res){
						if (res) {
							clear_brgy()
							get_brgy()
							$('#modal_brgy').modal('hide');
							saved(res)
						}
					})
				)
				.catch(() => {
				    Swal.fire({
				      icon: 'error',
				      title: 'Error occured'
				    })
				})
			}
		})
	}

	function clear_brgy(){
		barangay_id = 0;
		document.getElementById('form_barangay').reset()
		document.getElementById('barangay_name').value = "";
		document.getElementById('rmv_brgy').style.display = 'none';
	}
</script>